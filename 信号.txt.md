## 软件部分

### Init模块

- 初始化：标定原点和限位，并输出脉冲数。

- 控制电机逐步正转，直到停止信号为真，标为终点。然后控制电机反向逐步转动，并记录脉冲数，直到停止信号为真，标为原点。

- 6路电动机依次完成init操作。

- 输入：rst,sysclk,Stop

  - rst为复位信号，下降沿有效，决定init操作；
  - sysclk为系统时钟，上升沿有效；
  - Stop为传感器传回信号，假设上升沿有效，即电机转至限位时传感器发送高电平。

- 输出：initNum,initDR,initFlag

  - 根据Stop输出DR信号以控制电机运动方向；

  - 根据Stop输出initFlag到Pulse模块以控制电机的逐步运动；

  - 标定原点后输出initNum到Map模块以设定规则。

    比特位数根据实际情况调整，比如驱动器最小细分到128（虽然可能用不到），结合步进电机20步一转，可以得到最多2560步一转，而给定器件全程大约3/4转，不到2048步，此时便可以设置为11比特。



### Input模块

- 通过按键输入电机编号和坐标值，并输出。
- 按键方式：
  - 5键{Left,Right,Enter,Up,Down}：通过Left/Right键切换电机/坐标位，通过Up/Down键改变坐标值大小，通过Enter键选中。
- 输入：sysclk,Left,Right,Enter,Up,Down
  - sysclk为系统时钟，上升沿有效；
  - Left,Right,Enter,Up,Down为输入控制，假设下降沿有效。


- 输出：Motor,Value,inputLock

  - inputLock为假时根据Left/Right输出Motor到Control模块和Pulse模块以选定电机；

    1. ABCDEF，6bit，1比特位表示选中该电机，1比特位有且只有1位，后续可用组合逻辑选择电机。
    2. XYZ，3bit，编号二进制表示，不大于5，后可用case语句或者组合逻辑选择电机。
    3. A = !(X|Y|Z),B=!(X|Y|!Z),C=Y&!Z,D=Y&Z,E=X&!Z,F=X&Z

  - inputLock为真时根据按键输入输出Value到Control模块以计算位移；

    假设为10bit，即0~1023，比特位数根据输入位移位数确定，例如3位设定10比特，2位设定7比特。

  - 根据按键输入输出inputLock到Control模块，作为输入未完成标志，为真时Control不响应。





### Control模块

- 根据输入产生电机位移MotorValue和方向信号DR。

- 保存上次电机坐标，和输入坐标比较，计算出位移值和方向信号。

- 输入：sysclk,rst,initFlag,Motor,Value,InputLock,Busy

  - sysclk为系统时钟，上升沿有效；
  - rst为复位信号，下降沿有效；
  - initFlag为init模块输出，高电平有效，即代表init操作已完成；
  - Motor,Value,inputLock为Input模块输出，inputLock低电平有效，即代表Input操作已完成；根据输入
  - Busy为Pulse模块输出，低电平有效，即代表此时Pulse模块可发射脉冲。

- 输出：MotorValue,DR

  - 根据输入输出MotorValue，即电机位移值到Map模块，以转化为脉冲数。

    比特位数和Value保持一致。

  - 根据Value和Motor以及上次坐标值输出DR，以控制电机方向，高电平表示反转。



### Map模块

- 将输入位移值转换为脉冲数。

- 映射方法

  1. MotorValue / 已知总路程 = PulseNum / initNum

     PulseNum = MotorValue * (initNum/已知总路程) //由于存在乘除法，需要进一步改善

  2. 建立MotorValue->PulseNum的映射表，直接查表

- 输入：sysclk,initNum,MotorValue

  - sysclk为系统时钟，上升沿有效；
  - initNum为init模块输出；
  - MotorValue为Control模块输出。

- 输出：PulseNum

  - PulseNum为脉冲数，比特数与initNum保持一致。



### Pulse模块

- 根据输入信号产生脉冲信号。
- initFlag为假时不断发送脉冲以驱动电机逐步转动，initFlag为真时根据输入脉冲数发送脉冲。
- 输入：sysclk,initFlag,Motor,PulseNum
  - sysclk为系统时钟，上升沿有效；
  - initFlag为init模块输出值；
  - Motor为Input模块输出值；
  - PulseNum为Map模块输出值。
- 输出：PU,MF,Busy
  - PU为脉冲信号，下降沿有效，频率和电机有关；
  - MF为上电信号，高电平有效；
  - Busy为回馈信号，高电平表示正在发送脉冲，不可接收新信号。



### Display模块

- 显示输入信息，如电机编号和当前坐标值。

---



## 关于电机

- 二相混合式，20步/周，$18^\circ\pm10^\circ$ /步。

---



## 关于驱动器

- PU：下降沿有效，低0-0.5V，高4-5V，脉宽>2.5us（f<150kHz，考虑到实际，f初始值应当较小），占空比默认为50%。
- DR：控制方向
- MF：低电平有效（断电）


